<html>

<head>
    <title>atcoder-graph-generator</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.createjs.com/1.0.0/createjs.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <a class="navbar-brand" href="#">AtCoder RatingGraph Generator</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
            </ul>
            <form class="form-inline my-2 my-lg-0" method="GET">
                <input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search" name="username">
                <button class="btn x-outline-success my-2 my-sm-0" type="submit">Search</button>
            </form>
        </div>
    </nav>
    {{username}}
    <div>
        <canvas id="ratingStatus" width="640" height="80"></canvas>
    </div>
    <div>
        <canvas id="ratingGraph" width="640" height="360"></canvas>
    </div>

    <span style="display:none" id="rating_history">
        {{rating_json}}
    </span>
</body>

</html>
<style>
    body {
        text-align: center;
        margin: auto;
    }
</style>
<script>
    "use strict";
    (function () {
        $(document).ready(init);
        // console.log("hello");

        // const rating_history = [{ "EndTime": 1468677000, "NewRating": 1318, "OldRating": 0, "Place": 58, "ContestName": "AtCoder Grand Contest 001", "StandingsUrl": "/contests/agc001/standings?watching=maroonrk" },
        // { "EndTime": 1469281200, "NewRating": 1641, "OldRating": 1318, "Place": 75, "ContestName": "AtCoder Regular Contest 058", "StandingsUrl": "/contests/arc058/standings?watching=maroonrk" },
        // { "EndTime": 1469973000, "NewRating": 1863, "OldRating": 1641, "Place": 74, "ContestName": "AtCoder Grand Contest 002", "StandingsUrl": "/contests/agc002/standings?watching=maroonrk" }];
        const rating_history = JSON.parse($("#rating_history").text());
        // const rating_history=[{"EndTime":1523713800,"NewRating":37,"OldRating":0,"Place":630,"ContestName":"AtCoder Beginner Contest 094","StandingsUrl":"/contests/abc094/standings?watching=yuji9511"},{"EndTime":1525527600,"NewRating":121,"OldRating":37,"Place":1115,"ContestName":"AtCoder Beginner Contest 096","StandingsUrl":"/contests/abc096/standings?watching=yuji9511"},{"EndTime":1526132400,"NewRating":242,"OldRating":121,"Place":461,"ContestName":"AtCoder Beginner Contest 097","StandingsUrl":"/contests/abc097/standings?watching=yuji9511"},{"EndTime":1526825400,"NewRating":486,"OldRating":242,"Place":928,"ContestName":"AtCoder Grand Contest 024","StandingsUrl":"/contests/agc024/standings?watching=yuji9511"},{"EndTime":1527342000,"NewRating":668,"OldRating":486,"Place":156,"ContestName":"AtCoder Beginner Contest 098","StandingsUrl":"/contests/abc098/standings?watching=yuji9511"},{"EndTime":1528035000,"NewRating":767,"OldRating":668,"Place":1002,"ContestName":"AtCoder Grand Contest 025","StandingsUrl":"/contests/agc025/standings?watching=yuji9511"},{"EndTime":1528638000,"NewRating":751,"OldRating":767,"Place":1217,"ContestName":"AtCoder Beginner Contest 099","StandingsUrl":"/contests/abc099/standings?watching=yuji9511"},{"EndTime":1529156400,"NewRating":824,"OldRating":751,"Place":697,"ContestName":"AtCoder Beginner Contest 100","StandingsUrl":"/contests/abc100/standings?watching=yuji9511"},{"EndTime":1529761200,"NewRating":894,"OldRating":824,"Place":216,"ContestName":"AtCoder Beginner Contest 101","StandingsUrl":"/contests/abc101/standings?watching=yuji9511"},{"EndTime":1530450600,"NewRating":1001,"OldRating":894,"Place":85,"ContestName":"AtCoder Beginner Contest 102","StandingsUrl":"/contests/abc102/standings?watching=yuji9511"},{"EndTime":1530972000,"NewRating":1066,"OldRating":1001,"Place":606,"ContestName":"SoundHound Inc. Programming Contest 2018 -Masters Tournament-","StandingsUrl":"/contests/soundhound2018-summer-qual/standings?watching=yuji9511"},{"EndTime":1533476400,"NewRating":1088,"OldRating":1066,"Place":554,"ContestName":"AtCoder Beginner Contest 104","StandingsUrl":"/contests/abc104/standings?watching=yuji9511"},{"EndTime":1534599600,"NewRating":1151,"OldRating":1088,"Place":293,"ContestName":"AtCoder Beginner Contest 106","StandingsUrl":"/contests/abc106/standings?watching=yuji9511"},{"EndTime":1535809200,"NewRating":1102,"OldRating":1151,"Place":782,"ContestName":"AtCoder Beginner Contest 108","StandingsUrl":"/contests/abc108/standings?watching=yuji9511"},{"EndTime":1536414000,"NewRating":3079,"OldRating":1102,"Place":1044,"ContestName":"AtCoder Beginner Contest 109","StandingsUrl":"/contests/abc109/standings?watching=yuji9511"},{"EndTime":1537021200,"NewRating":1163,"OldRating":3079,"Place":535,"ContestName":"AtCoder Grand Contest 027","StandingsUrl":"/contests/agc027/standings?watching=yuji9511"},{"EndTime":1538228400,"NewRating":1145,"OldRating":1163,"Place":422,"ContestName":"AtCoder Beginner Contest 111","StandingsUrl":"/contests/abc111/standings?watching=yuji9511"},{"EndTime":1538833200,"NewRating":1167,"OldRating":1145,"Place":460,"ContestName":"AtCoder Beginner Contest 112","StandingsUrl":"/contests/abc112/standings?watching=yuji9511"},{"EndTime":1539441000,"NewRating":1225,"OldRating":1167,"Place":572,"ContestName":"AtCoder Grand Contest 028","StandingsUrl":"/contests/agc028/standings?watching=yuji9511"},{"EndTime":1540647600,"NewRating":1203,"OldRating":1225,"Place":674,"ContestName":"Tenka1 Programmer Contest","StandingsUrl":"/contests/tenka1-2018/standings?watching=yuji9511"},{"EndTime":1543064400,"NewRating":1185,"OldRating":1203,"Place":865,"ContestName":"第5回 ドワンゴからの挑戦状 予選","StandingsUrl":"/contests/dwacon5th-prelims/standings?watching=yuji9511"},{"EndTime":1543758000,"NewRating":1192,"OldRating":1185,"Place":440,"ContestName":"AtCoder Beginner Contest 114","StandingsUrl":"/contests/abc114/standings?watching=yuji9511"},{"EndTime":1544883600,"NewRating":1271,"OldRating":1192,"Place":477,"ContestName":"AtCoder Grand Contest 029","StandingsUrl":"/contests/agc029/standings?watching=yuji9511"},{"EndTime":1545487200,"NewRating":1339,"OldRating":1271,"Place":291,"ContestName":"CADDi 2018","StandingsUrl":"/contests/caddi2018/standings?watching=yuji9511"},{"EndTime":1547301600,"NewRating":1403,"OldRating":1339,"Place":312,"ContestName":"エイシング プログラミング コンテスト 2019","StandingsUrl":"/contests/aising2019/standings?watching=yuji9511"},{"EndTime":1547388000,"NewRating":1441,"OldRating":1403,"Place":429,"ContestName":"キーエンス プログラミング コンテスト 2019","StandingsUrl":"/contests/keyence2019/standings?watching=yuji9511"},{"EndTime":1548597600,"NewRating":19,"OldRating":1441,"Place":1238,"ContestName":"全国統一プログラミング王決定戦予選","StandingsUrl":"/contests/nikkei2019-qual/standings?watching=yuji9511"},{"EndTime":1549720800,"NewRating":1453,"OldRating":19,"Place":603,"ContestName":"「みんなのプロコン 2019」","StandingsUrl":"/contests/yahoo-procon2019-qual/standings?watching=yuji9511"},{"EndTime":1552747200,"NewRating":1482,"OldRating":1453,"Place":631,"ContestName":"AtCoder Grand Contest 031","StandingsUrl":"/contests/agc031/standings?watching=yuji9511"},{"EndTime":1553352600,"NewRating":1507,"OldRating":1482,"Place":525,"ContestName":"AtCoder Grand Contest 032","StandingsUrl":"/contests/agc032/standings?watching=yuji9511"},{"EndTime":1553954400,"NewRating":1517,"OldRating":1507,"Place":696,"ContestName":"エクサウィザーズ 2019","StandingsUrl":"/contests/exawizards2019/standings?watching=yuji9511"},{"EndTime":1555767600,"NewRating":1496,"OldRating":1517,"Place":825,"ContestName":"Tenka1 Programmer Contest 2019","StandingsUrl":"/contests/tenka1-2019/standings?watching=yuji9511"},{"EndTime":1558791600,"NewRating":1469,"OldRating":1496,"Place":1315,"ContestName":"AtCoder Beginner Contest 127","StandingsUrl":"/contests/abc127/standings?watching=yuji9511"},{"EndTime":1558878000,"NewRating":1474,"OldRating":1469,"Place":700,"ContestName":"AtCoder Beginner Contest 128","StandingsUrl":"/contests/abc128/standings?watching=yuji9511"},{"EndTime":1559484000,"NewRating":1485,"OldRating":1474,"Place":709,"ContestName":"AtCoder Grand Contest 034","StandingsUrl":"/contests/agc034/standings?watching=yuji9511"},{"EndTime":1560087600,"NewRating":1495,"OldRating":1485,"Place":540,"ContestName":"AtCoder Beginner Contest 129","StandingsUrl":"/contests/abc129/standings?watching=yuji9511"},{"EndTime":1560607200,"NewRating":1564,"OldRating":1495,"Place":264,"ContestName":"diverta 2019 Programming Contest 2","StandingsUrl":"/contests/diverta2019-2/standings?watching=yuji9511"},{"EndTime":1560692400,"NewRating":1596,"OldRating":1564,"Place":300,"ContestName":"AtCoder Beginner Contest 130","StandingsUrl":"/contests/abc130/standings?watching=yuji9511"},{"EndTime":1561210800,"NewRating":1619,"OldRating":1596,"Place":345,"ContestName":"AtCoder Beginner Contest 131","StandingsUrl":"/contests/abc131/standings?watching=yuji9511"},{"EndTime":1561815600,"NewRating":1644,"OldRating":1619,"Place":306,"ContestName":"AtCoder Beginner Contest 132","StandingsUrl":"/contests/abc132/standings?watching=yuji9511"},{"EndTime":1562506800,"NewRating":1649,"OldRating":1644,"Place":484,"ContestName":"AtCoder Beginner Contest 133","StandingsUrl":"/contests/abc133/standings?watching=yuji9511"},{"EndTime":1563115200,"NewRating":1717,"OldRating":1649,"Place":229,"ContestName":"AtCoder Grand Contest 035","StandingsUrl":"/contests/agc035/standings?watching=yuji9511"},{"EndTime":1563630000,"NewRating":1807,"OldRating":1717,"Place":32,"ContestName":"AtCoder Beginner Contest 134","StandingsUrl":"/contests/abc134/standings?watching=yuji9511"},{"EndTime":1564234800,"NewRating":1816,"OldRating":1807,"Place":259,"ContestName":"AtCoder Beginner Contest 135","StandingsUrl":"/contests/abc135/standings?watching=yuji9511"},{"EndTime":1564926000,"NewRating":1853,"OldRating":1816,"Place":154,"ContestName":"AtCoder Beginner Contest 136","StandingsUrl":"/contests/abc136/standings?watching=yuji9511"},{"EndTime":1565444400,"NewRating":1852,"OldRating":1853,"Place":308,"ContestName":"AtCoder Beginner Contest 137","StandingsUrl":"/contests/abc137/standings?watching=yuji9511"},{"EndTime":1566135600,"NewRating":1877,"OldRating":1852,"Place":175,"ContestName":"AtCoder Beginner Contest 138","StandingsUrl":"/contests/abc138/standings?watching=yuji9511"},{"EndTime":1566654000,"NewRating":1854,"OldRating":1877,"Place":658,"ContestName":"第一回日本最強プログラマー学生選手権-予選-","StandingsUrl":"/contests/jsc2019-qual/standings?watching=yuji9511"},{"EndTime":1567345200,"NewRating":1820,"OldRating":1854,"Place":837,"ContestName":"AtCoder Beginner Contest 139","StandingsUrl":"/contests/abc139/standings?watching=yuji9511"},{"EndTime":1567863600,"NewRating":1833,"OldRating":1820,"Place":257,"ContestName":"AtCoder Beginner Contest 140","StandingsUrl":"/contests/abc140/standings?watching=yuji9511"},{"EndTime":1568554800,"NewRating":1843,"OldRating":1833,"Place":227,"ContestName":"AtCoder Beginner Contest 141","StandingsUrl":"/contests/abc141/standings?watching=yuji9511"},{"EndTime":1569073800,"NewRating":1873,"OldRating":1843,"Place":251,"ContestName":"AtCoder Grand Contest 038","StandingsUrl":"/contests/agc038/standings?watching=yuji9511"},{"EndTime":1569678000,"NewRating":1867,"OldRating":1873,"Place":338,"ContestName":"AtCoder Beginner Contest 142","StandingsUrl":"/contests/abc142/standings?watching=yuji9511"},{"EndTime":1571492400,"NewRating":1841,"OldRating":1867,"Place":542,"ContestName":"AtCoder Beginner Contest 143","StandingsUrl":"/contests/abc143/standings?watching=yuji9511"},{"EndTime":1572183600,"NewRating":1862,"OldRating":1841,"Place":206,"ContestName":"AtCoder Beginner Contest 144","StandingsUrl":"/contests/abc144/standings?watching=yuji9511"},{"EndTime":1572802200,"NewRating":1889,"OldRating":1862,"Place":221,"ContestName":"AtCoder Grand Contest 040","StandingsUrl":"/contests/agc040/standings?watching=yuji9511"},{"EndTime":1573308000,"NewRating":1882,"OldRating":1889,"Place":493,"ContestName":"第二回全国統一プログラミング王決定戦予選","StandingsUrl":"/contests/nikkei2019-2-qual/standings?watching=yuji9511"},{"EndTime":1573911600,"NewRating":1912,"OldRating":1882,"Place":164,"ContestName":"AtCoder Beginner Contest 145","StandingsUrl":"/contests/abc145/standings?watching=yuji9511"},{"EndTime":1574516400,"NewRating":1874,"OldRating":1912,"Place":791,"ContestName":"DISCO presents ディスカバリーチャンネル コードコンテスト2020 予選","StandingsUrl":"/contests/ddcc2020-qual/standings?watching=yuji9511"},{"EndTime":1574602800,"NewRating":1939,"OldRating":1874,"Place":73,"ContestName":"AtCoder Beginner Contest 146","StandingsUrl":"/contests/abc146/standings?watching=yuji9511"}];

        const MARGIN_VAL_X = 86400 * 30;
        const MARGIN_VAL_Y_LOW = 100;
        const MARGIN_VAL_Y_HIGH = 300;
        const OFFSET_X = 50;
        const OFFSET_Y = 5;
        const DEFAULT_WIDTH = 640;
        var canvas_status = document.getElementById("ratingStatus");
        const STATUS_WIDTH = canvas_status.width - OFFSET_X - 10;
        const STATUS_HEIGHT = canvas_status.height - OFFSET_Y - 5;
        var canvas_graph = document.getElementById("ratingGraph");
        const PANEL_WIDTH = canvas_graph.width - OFFSET_X - 10;
        const PANEL_HEIGHT = canvas_graph.height - OFFSET_Y - 30;
        const HIGHEST_WIDTH = 80;
        const HIGHEST_HEIGHT = 20;
        const LABEL_FONT = "12px Lato";
        const START_YEAR = 2010;
        const MONTH_NAMES = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const YEAR_SEC = 86400 * 365;
        const STEP_SIZE = 400;
        const COLORS = [
            [0, "#808080", 0.15],
            [400, "#804000", 0.15],
            [800, "#008000", 0.15],
            [1200, "#00C0C0", 0.2],
            [1600, "#0000FF", 0.1],
            [2000, "#C0C000", 0.25],
            [2400, "#FF8000", 0.2],
            [2800, "#FF0000", 0.1]
        ];
        const STAR_MIN = 3200;
        const PARTICLE_MIN = 3;
        const PARTICLE_MAX = 20;
        const LIFE_MAX = 30;
        const EPS = 1e-9;

        var cj = createjs;
        var stage_graph, stage_status;

        // graph
        var panel_shape, border_shape;
        var chart_container, line_shape, vertex_shapes, highest_shape;
        var n, x_min, x_max, y_min, y_max;

        // status
        var border_status_shape;
        var rating_text, place_text, diff_text, date_text, contest_name_text;
        var particles;
        var standings_url;

        function initStage(stage, canvas) {
            var width = canvas.getAttribute('width');
            var height = canvas.getAttribute('height');
            if (window.devicePixelRatio) {
                canvas.setAttribute('width', Math.round(width * window.devicePixelRatio));
                canvas.setAttribute('height', Math.round(height * window.devicePixelRatio));
                stage.scaleX = stage.scaleY = window.devicePixelRatio;
            }
            canvas.style.maxWidth = width + "px";
            canvas.style.maxHeight = height + "px";
            canvas.style.width = canvas.style.height = "100%";
            stage.enableMouseOver();
        }

        function newShape(parent) {
            var s = new cj.Shape();
            parent.addChild(s);
            return s;
        }

        function newText(parent, x, y, font) {
            var t = new cj.Text("", font, "#000");
            t.x = x;
            t.y = y;
            t.textAlign = "center";
            t.textBaseline = "middle";
            parent.addChild(t);
            return t;
        }

        function init() {
            console.log("init");
            n = rating_history.length;
            console.log(n);
            if (n == 0) return;
            console.log(cj);

            stage_graph = new cj.Stage("ratingGraph");
            stage_status = new cj.Stage("ratingStatus");
            initStage(stage_graph, canvas_graph);
            initStage(stage_status, canvas_status);

            x_min = 100000000000;
            x_max = 0;
            y_min = 10000;
            y_max = 0;
            for (var i = 0; i < n; i++) {
                x_min = Math.min(x_min, rating_history[i].EndTime);
                x_max = Math.max(x_max, rating_history[i].EndTime);
                y_min = Math.min(y_min, rating_history[i].NewRating);
                y_max = Math.max(y_max, rating_history[i].NewRating);
            }
            x_min -= MARGIN_VAL_X;
            x_max += MARGIN_VAL_X;
            y_min = Math.min(1500, Math.max(0, y_min - MARGIN_VAL_Y_LOW));
            y_max += MARGIN_VAL_Y_HIGH;

            initBackground();
            initChart();
            stage_graph.update();
            initStatus();
            stage_status.update();

            cj.Ticker.setFPS(60);
            cj.Ticker.addEventListener("tick", handleTick);

            function handleTick(event) {
                updateParticles();
                stage_status.update();
            }
        }

        function getPer(x, l, r) {
            return (x - l) / (r - l);
        }

        function getColor(x) {
            for (var i = COLORS.length - 1; i >= 0; i--) {
                if (x >= COLORS[i][0]) return COLORS[i];
            }
            return [-1, "#000000", 0.1];
        }

        function initBackground() {
            panel_shape = newShape(stage_graph);
            panel_shape.x = OFFSET_X;
            panel_shape.y = OFFSET_Y;
            panel_shape.alpha = 0.3;
            border_shape = newShape(stage_graph);
            border_shape.x = OFFSET_X;
            border_shape.y = OFFSET_Y;

            function newLabelY(s, y) {
                var t = new cj.Text(s, LABEL_FONT, "#000");
                t.x = OFFSET_X - 10;
                t.y = OFFSET_Y + y;
                t.textAlign = "right";
                t.textBaseline = "middle";
                stage_graph.addChild(t);
            }

            function newLabelX(s, x, y) {
                var t = new cj.Text(s, LABEL_FONT, "#000");
                t.x = OFFSET_X + x;
                t.y = OFFSET_Y + PANEL_HEIGHT + 2 + y;
                t.textAlign = "center";
                t.textBaseline = "top";
                stage_graph.addChild(t);
            }
            var y1 = 0;
            for (var i = COLORS.length - 1; i >= 0; i--) {
                var y2 = PANEL_HEIGHT - PANEL_HEIGHT * getPer(COLORS[i][0], y_min, y_max);
                if (y2 > 0 && y1 < PANEL_HEIGHT) {
                    y1 = Math.max(y1, 0);
                    panel_shape.graphics.f(COLORS[i][1]).r(0, y1, PANEL_WIDTH, Math.min(y2, PANEL_HEIGHT) - y1);
                }
                y1 = y2;
            }
            for (var i = 0; i <= y_max; i += STEP_SIZE) {
                if (i >= y_min) {
                    var y = PANEL_HEIGHT - PANEL_HEIGHT * getPer(i, y_min, y_max);
                    newLabelY(String(i), y);
                    border_shape.graphics.s("#FFF").ss(0.5);
                    if (i == 2000) border_shape.graphics.s("#000");
                    border_shape.graphics.mt(0, y).lt(PANEL_WIDTH, y);
                }
            }
            border_shape.graphics.s("#FFF").ss(0.5);

            var month_step = 6;
            for (var i = 3; i >= 1; i--) {
                if (x_max - x_min <= YEAR_SEC * i + MARGIN_VAL_X * 2) month_step = i;
            }
            var first_flag = true;
            for (var i = START_YEAR; i < 3000; i++) {
                var break_flag = false;
                for (var j = 0; j < 12; j += month_step) {
                    var month = ('00' + (j + 1)).slice(-2);
                    var unix = Date.parse(String(i) + "-" + month + "-01T00:00:00") / 1000;
                    if (x_min < unix && unix < x_max) {
                        var x = PANEL_WIDTH * getPer(unix, x_min, x_max);
                        if (j == 0 || first_flag) {
                            newLabelX(MONTH_NAMES[j], x, 0);
                            newLabelX(String(i), x, 13);
                            first_flag = false;
                        } else {
                            newLabelX(MONTH_NAMES[j], x, 0);
                        }
                        border_shape.graphics.mt(x, 0).lt(x, PANEL_HEIGHT)
                    }
                    if (unix > x_max) { break_flag = true; break; }
                }
                if (break_flag) break;
            }
            border_shape.graphics.s("#888").ss(1.5).rr(0, 0, PANEL_WIDTH, PANEL_HEIGHT, 2);
        }

        function initChart() {
            chart_container = new cj.Container();
            stage_graph.addChild(chart_container);
            chart_container.shadow = new cj.Shadow("rgba(0,0,0,0.3)", 1, 2, 3);

            line_shape = newShape(chart_container);
            highest_shape = newShape(chart_container);
            vertex_shapes = new Array();

            function mouseoverVertex(e) {
                vertex_shapes[e.target.i].scaleX = vertex_shapes[e.target.i].scaleY = 1.2;
                stage_graph.update();
                setStatus(rating_history[e.target.i], true);
            };

            function mouseoutVertex(e) {
                vertex_shapes[e.target.i].scaleX = vertex_shapes[e.target.i].scaleY = 1;
                stage_graph.update();
            };
            var highest_i = 0;
            for (var i = 0; i < n; i++) {
                if (rating_history[highest_i].NewRating < rating_history[i].NewRating) {
                    highest_i = i;
                }
            }
            for (var i = 0; i < n; i++) {
                vertex_shapes.push(newShape(chart_container));
                vertex_shapes[i].graphics.s("#FFF");
                if (i == highest_i) vertex_shapes[i].graphics.s("#000");
                vertex_shapes[i].graphics.ss(0.5).f(getColor(rating_history[i].NewRating)[1]).dc(0, 0, 3.5);
                vertex_shapes[i].x = OFFSET_X + PANEL_WIDTH * getPer(rating_history[i].EndTime, x_min, x_max);
                vertex_shapes[i].y = OFFSET_Y + (PANEL_HEIGHT - PANEL_HEIGHT * getPer(rating_history[i].NewRating, y_min, y_max));
                vertex_shapes[i].i = i;
                var hitArea = new cj.Shape();
                hitArea.graphics.f("#000").dc(1.5, 1.5, 6);
                vertex_shapes[i].hitArea = hitArea;
                vertex_shapes[i].addEventListener("mouseover", mouseoverVertex);
                vertex_shapes[i].addEventListener("mouseout", mouseoutVertex);
            }
            {
                var dx = 80;
                if ((x_min + x_max) / 2 < rating_history[highest_i].EndTime) dx = -80;
                var x = vertex_shapes[highest_i].x + dx;
                var y = vertex_shapes[highest_i].y - 16;
                highest_shape.graphics.s("#FFF").mt(vertex_shapes[highest_i].x, vertex_shapes[highest_i].y).lt(x, y);
                highest_shape.graphics.s("#888").f("#FFF").rr(x - HIGHEST_WIDTH / 2, y - HIGHEST_HEIGHT / 2, HIGHEST_WIDTH, HIGHEST_HEIGHT, 2);
                highest_shape.i = highest_i;
                var highest_text = newText(stage_graph, x, y, "12px Lato");
                highest_text.text = "Highest: " + rating_history[highest_i].NewRating;
                highest_shape.addEventListener("mouseover", mouseoverVertex);
                highest_shape.addEventListener("mouseout", mouseoutVertex);
            }
            for (var j = 0; j < 2; j++) {
                if (j == 0) line_shape.graphics.s("#AAA").ss(2);
                else line_shape.graphics.s("#FFF").ss(0.5);
                line_shape.graphics.mt(vertex_shapes[0].x, vertex_shapes[0].y);
                for (var i = 0; i < n; i++) {
                    line_shape.graphics.lt(vertex_shapes[i].x, vertex_shapes[i].y);
                }
            }
        }

        function initStatus() {
            border_status_shape = newShape(stage_status);
            rating_text = newText(stage_status, OFFSET_X + 80, OFFSET_Y + STATUS_HEIGHT / 2, "48px 'Squada One'");
            place_text = newText(stage_status, OFFSET_X + 160, OFFSET_Y + STATUS_HEIGHT / 2.7, "16px Lato");
            diff_text = newText(stage_status, OFFSET_X + 160, OFFSET_Y + STATUS_HEIGHT / 1.5, "11px Lato");
            diff_text.color = '#888';
            date_text = newText(stage_status, OFFSET_X + 200, OFFSET_Y + STATUS_HEIGHT / 4, "14px Lato");
            contest_name_text = newText(stage_status, OFFSET_X + 200, OFFSET_Y + STATUS_HEIGHT / 1.6, "20px Lato");
            date_text.textAlign = contest_name_text.textAlign = "left";
            contest_name_text.maxWidth = STATUS_WIDTH - 200 - 10;
            {
                var hitArea = new cj.Shape(); hitArea.graphics.f("#000").r(0, -12, contest_name_text.maxWidth, 24);
                contest_name_text.hitArea = hitArea;
                contest_name_text.cursor = "pointer";
                contest_name_text.addEventListener("click", function () {
                    location.href = standings_url;
                });
            }
            particles = new Array();
            for (var i = 0; i < PARTICLE_MAX; i++) {
                particles.push(newText(stage_status, 0, 0, "64px Lato"));
                particles[i].visible = false;
            }
            setStatus(rating_history[rating_history.length - 1], false);
        }

        function getRatingPer(x) {
            var pre = COLORS[COLORS.length - 1][0] + STEP_SIZE;
            for (var i = COLORS.length - 1; i >= 0; i--) {
                if (x >= COLORS[i][0]) return (x - COLORS[i][0]) / (pre - COLORS[i][0]);
                pre = COLORS[i][0];
            }
            return 0;
        }

        function getOrdinal(x) {
            var s = ["th", "st", "nd", "rd"], v = x % 100;
            return x + (s[(v - 20) % 10] || s[v] || s[0]);
        }
        function getDiff(x) {
            var sign = x == 0 ? '±' : (x < 0 ? '-' : '+');
            return sign + Math.abs(x);
        }

        function setStatus(data, particle_flag) {
            var date = new Date(data.EndTime * 1000);
            var rating = data.NewRating, old_rating = data.OldRating;
            var place = data.Place;
            var contest_name = data.ContestName;
            var tmp = getColor(rating); var color = tmp[1], alpha = tmp[2];
            border_status_shape.graphics.c().s(color).ss(1).rr(OFFSET_X, OFFSET_Y, STATUS_WIDTH, STATUS_HEIGHT, 2);
            rating_text.text = rating;
            rating_text.color = color;
            place_text.text = getOrdinal(place);
            diff_text.text = getDiff(rating - old_rating);
            date_text.text = date.toLocaleDateString();
            contest_name_text.text = contest_name;
            if (particle_flag) {
                var particle_num = parseInt(Math.pow(getRatingPer(rating), 2) * (PARTICLE_MAX - PARTICLE_MIN) + PARTICLE_MIN);
                setParticles(particle_num, color, alpha, rating);
            }
            standings_url = data.StandingsUrl;
        }

        function setParticle(particle, x, y, color, alpha, star_flag) {
            particle.x = x;
            particle.y = y;
            var ang = Math.random() * Math.PI * 2;
            var speed = Math.random() * 4 + 4;
            particle.vx = Math.cos(ang) * speed;
            particle.vy = Math.sin(ang) * speed;
            particle.rot_speed = Math.random() * 20 + 10;
            particle.life = LIFE_MAX;
            particle.visible = true;
            particle.color = color;
            if (star_flag) {
                particle.text = "★";
            } else {
                particle.text = "@";
            }
            particle.alpha = alpha;
        }

        function setParticles(num, color, alpha, rating) {
            for (var i = 0; i < PARTICLE_MAX; i++) {
                if (i < num) {
                    setParticle(particles[i], rating_text.x, rating_text.y, color, alpha, rating >= STAR_MIN);
                } else {
                    particles[i].life = 0;
                    particles[i].visible = false;
                }
            }
        }

        function updateParticle(particle) {
            if (particle.life <= 0) {
                particle.visible = false;
                return;
            }
            particle.x += particle.vx;
            particle.vx *= 0.9;
            particle.y += particle.vy;
            particle.vy *= 0.9;
            particle.life--;
            particle.scaleX = particle.scaleY = particle.life / LIFE_MAX;
            particle.rotation += particle.rot_speed;
        }

        function updateParticles() {
            for (var i = 0; i < PARTICLE_MAX; i++) {
                if (particles[i].life > 0) {
                    updateParticle(particles[i]);
                }
            }
        }

        $('#rating-graph-expand').click(function () {
            canvas_status.style.maxWidth = canvas_status.style.maxHeight = "";
            canvas_graph.style.maxWidth = canvas_graph.style.maxHeight = "";
            $(this).css('cssText', 'display: none !important;');
        });
    })();

</script>